name: Auto Tweet New Blog Posts

on:
  push:
    branches: [ main ]
    paths:
      - '_posts/*.md'

jobs:
  tweet:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã™ã‚‹ãŸã‚

    - name: Get changed files
      id: changed-files
      run: |
        # æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸè¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        NEW_POSTS=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep '^_posts/.*\.md$' || true)
        if [ -n "$NEW_POSTS" ]; then
          echo "æ–°ã—ã„è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
          echo "$NEW_POSTS"
          echo "new_posts<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_POSTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "æ–°ã—ã„è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“"
          echo "new_posts=" >> $GITHUB_OUTPUT
        fi

    - name: Extract post metadata
      id: metadata
      if: steps.changed-files.outputs.new_posts != ''
      run: |
        # æœ€åˆã®æ–°ã—ã„è¨˜äº‹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        POST_FILE=$(echo "${{ steps.changed-files.outputs.new_posts }}" | head -n1)
        echo "è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«: $POST_FILE"
        
        # ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
        TITLE=$(grep '^title:' "$POST_FILE" | sed 's/title: *["'"'"']*\(.*\)["'"'"']*$/\1/' | sed 's/^"//;s/"$//')
        echo "ã‚¿ã‚¤ãƒˆãƒ«: $TITLE"
        
        # æ—¥ä»˜ã‚’æŠ½å‡º
        DATE=$(grep '^date:' "$POST_FILE" | sed 's/date: *//')
        echo "æ—¥ä»˜: $DATE"
        
        # ã‚¿ã‚°ã‚’æŠ½å‡º
        TAGS=$(awk '/^tags:/{flag=1;next}/^[[:alpha:]]/&&flag{flag=0}flag&&/- /{gsub(/^[[:space:]]*-[[:space:]]*/, ""); print}' "$POST_FILE" | tr '\n' ' ')
        echo "ã‚¿ã‚°: $TAGS"
        
        # ã‚«ãƒ†ã‚´ãƒªã‚’æŠ½å‡º
        CATEGORIES=$(awk '/^categories:/{flag=1;next}/^[[:alpha:]]/&&flag{flag=0}flag&&/- /{gsub(/^[[:space:]]*-[[:space:]]*/, ""); print}' "$POST_FILE" | tr '\n' ' ')
        echo "ã‚«ãƒ†ã‚´ãƒª: $CATEGORIES"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰URLã‚’ç”Ÿæˆ
        FILENAME=$(basename "$POST_FILE" .md)
        URL_SLUG=$(echo "$FILENAME" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
        BLOG_URL="https://aoma23.com/${URL_SLUG}/"
        echo "URL: $BLOG_URL"
        
        # å‡ºåŠ›è¨­å®š
        echo "title=$TITLE" >> $GITHUB_OUTPUT
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "tags=$TAGS" >> $GITHUB_OUTPUT
        echo "categories=$CATEGORIES" >> $GITHUB_OUTPUT
        echo "url=$BLOG_URL" >> $GITHUB_OUTPUT
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT

    - name: Generate tweet content
      id: tweet
      if: steps.metadata.outputs.title != ''
      run: |
        # ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ã‚’ç”Ÿæˆ
        TITLE="${{ steps.metadata.outputs.title }}"
        URL="${{ steps.metadata.outputs.url }}"
        TAGS="${{ steps.metadata.outputs.tags }}"
        CATEGORIES="${{ steps.metadata.outputs.categories }}"
        
        # ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ç”Ÿæˆï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦Hashtagã«å¤‰æ›ï¼‰
        HASHTAGS=""
        for tag in $TAGS $CATEGORIES; do
          # æ—¥æœ¬èªã‚¿ã‚°ã¯ãã®ã¾ã¾ã€è‹±èªã‚¿ã‚°ã¯#ä»˜ã
          if echo "$tag" | grep -q '[ã-ã‚Ÿ]'; then
            continue  # æ—¥æœ¬èªã‚¿ã‚°ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆTwitterã§æ¤œç´¢ã•ã‚Œã«ãã„ãŸã‚ï¼‰
          else
            HASHTAGS="$HASHTAGS #$(echo "$tag" | sed 's/ //g')"
          fi
        done
        
        # ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ã‚’æ§‹ç¯‰
        INTRO="æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸğŸ“"
        TITLE_PART="ã€Œ${TITLE}ã€"
        
        # åŸºæœ¬çš„ãªãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ã‚’ä½œæˆ
        TWEET_TEXT="${INTRO}"$'\n\n'"${TITLE_PART}"$'\n\n'"${HASHTAGS}"$'\n'"${URL}"
        
        # æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆTwitteråˆ¶é™280æ–‡å­—ï¼‰
        CHAR_COUNT=$(echo -n "$TWEET_TEXT" | wc -c)
        echo "æ–‡å­—æ•°: $CHAR_COUNT"
        
        if [ $CHAR_COUNT -gt 280 ]; then
          # æ–‡å­—æ•°ã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’çŸ­ç¸®
          MAX_TITLE_LENGTH=$((200 - ${#INTRO} - ${#HASHTAGS} - ${#URL}))
          if [ $MAX_TITLE_LENGTH -lt 10 ]; then
            MAX_TITLE_LENGTH=10
          fi
          SHORT_TITLE=$(echo "$TITLE" | cut -c1-$MAX_TITLE_LENGTH)
          TITLE_PART="ã€Œ${SHORT_TITLE}...ã€"
          TWEET_TEXT="${INTRO}"$'\n\n'"${TITLE_PART}"$'\n\n'"${HASHTAGS}"$'\n'"${URL}"
        fi
        
        echo "ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹:"
        echo "$TWEET_TEXT"
        
        # GitHubã®å‡ºåŠ›å½¢å¼ã«åˆã‚ã›ã¦è¨­å®š
        echo "content<<EOF" >> $GITHUB_OUTPUT
        echo "$TWEET_TEXT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Post to Twitter
      if: steps.tweet.outputs.content != ''
      uses: ethomson/send-tweet-action@v1
      with:
        status: ${{ steps.tweet.outputs.content }}
        consumer-key: ${{ secrets.TWITTER_API_KEY }}
        consumer-secret: ${{ secrets.TWITTER_API_SECRET }}
        access-token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        access-token-secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}

    - name: Create summary
      if: always()
      run: |
        echo "## ğŸ¦ è‡ªå‹•ãƒ„ã‚¤ãƒ¼ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changed-files.outputs.new_posts }}" != "" ]; then
          echo "### ğŸ“ å¯¾è±¡è¨˜äº‹" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.metadata.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.metadata.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.changed-files.outputs.new_posts }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… ãƒ„ã‚¤ãƒ¼ãƒˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "è¨˜äº‹ãŒæ­£å¸¸ã«Twitterã«æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ãƒ„ã‚¤ãƒ¼ãƒˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "ãƒ„ã‚¤ãƒ¼ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### â„¹ï¸ æ–°ã—ã„è¨˜äº‹ãªã—" >> $GITHUB_STEP_SUMMARY
          echo "ä»Šå›ã®ã‚³ãƒŸãƒƒãƒˆã«ã¯æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
        fi
name: Auto Tweet New Blog Posts

on:
  push:
    branches: [ main ]
    paths:
      - '_posts/*.md'
  workflow_dispatch:
    inputs:
      post_file:
        description: 'Post file path (e.g., _posts/2025-08-14-example.md)'
        required: true
        type: string
      ref_branch:
        description: 'Branch to checkout (default: main)'
        required: false
        type: string

jobs:
  tweet:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Tokyo
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã™ã‚‹ãŸã‚
        # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯æŒ‡å®šãƒ–ãƒ©ãƒ³ãƒã‚’å„ªå…ˆï¼ˆæœªæŒ‡å®šãªã‚‰ mainï¼‰
        ref: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.ref_branch || 'refs/heads/main') || github.ref }}

    - name: Get changed files
      id: changed-files
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "files=${{ github.event.inputs.post_file }}" >> "$GITHUB_OUTPUT"
        else
          FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep '^_posts/.*\.md$' | head -1 || true)
          echo "files=$FILES" >> "$GITHUB_OUTPUT"
        fi

    - name: Extract post metadata
      id: metadata
      if: steps.changed-files.outputs.files != ''
      run: |
        POST_FILE="${{ steps.changed-files.outputs.files }}"
        echo "è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«: $POST_FILE"

        # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆæ‰‹å‹•å…¥åŠ›ãƒŸã‚¹ã‚’æ¤œå‡ºï¼‰
        if [ ! -f "$POST_FILE" ]; then
          echo "æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«å­˜åœ¨ã—ã¾ã›ã‚“: $POST_FILE" >&2
          exit 1
        fi
        
        # ãƒ•ãƒ­ãƒ³ãƒˆãƒžã‚¿ãƒ¼ç¯„å›²ã®ã¿ã‚’å¯¾è±¡
        FRONTMATTER=$(awk 'BEGIN{in=0} /^---[[:space:]]*$/ {c++; if(c==1){in=1; next} if(c==2){in=0; exit}} in{print}' "$POST_FILE")

        # ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡ºï¼ˆæœ€åˆã® title è¡Œï¼‰
        TITLE=$(printf "%s\n" "$FRONTMATTER" | awk -F': *' '/^title:/ {sub(/^title:[[:space:]]*/,"",$0); print; exit}' | sed 's/^"//;s/"$//')
        echo "ã‚¿ã‚¤ãƒˆãƒ«: $TITLE"
        
        # æ—¥ä»˜ã‚’æŠ½å‡ºï¼ˆæ™‚åˆ»ãŒä»˜ã„ã¦ã„ã¦ã‚‚å…ˆé ­10æ¡ã«æ­£è¦åŒ–ï¼‰
        DATE_RAW=$(printf "%s\n" "$FRONTMATTER" | awk -F': *' '/^date:/ {sub(/^date:[[:space:]]*/,"",$0); print; exit}')
        DATE=$(printf "%s" "$DATE_RAW" | sed -E 's/^([0-9]{4}-[0-9]{2}-[0-9]{2}).*$/\1/')
        echo "æ—¥ä»˜: $DATE"
        
        # ã‚¿ã‚°ã‚’æŠ½å‡ºï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é…åˆ—/è¤‡æ•°è¡Œé…åˆ— ä¸¡å¯¾å¿œï¼‰
        TAGS=""
        if printf "%s\n" "$FRONTMATTER" | grep -qE '^tags:[[:space:]]*\['; then
          # ä¾‹) tags: [foo, bar, "baz qux"]
          TAGS=$(printf "%s\n" "$FRONTMATTER" | grep -m1 '^tags:' \
            | sed -E 's/^tags:[[:space:]]*\[(.*)\][[:space:]]*$/\1/' \
            | tr ',' '\n' \
            | sed -E 's/^ *| *$//g' \
            | tr -d '"' \
            | tr '\n' ' ')
        elif printf "%s\n" "$FRONTMATTER" | grep -qE '^tags:[[:space:]]*$'; then
          # ä¾‹)
          # tags:\n#   - foo\n#   - "baz qux"
          TAGS=$(printf "%s\n" "$FRONTMATTER" | awk '
            found && /^[[:space:]]*-/ {
              sub(/^[[:space:]]*-[[:space:]]*/,"",$0);
              gsub(/[\r\n]+/,"",$0);
              print; next
            }
            found && NF==0 { next }
            found && !/^[[:space:]]*-/ { exit }
            /^tags:[[:space:]]*$/ { found=1 }
          ' \
          | sed -E 's/^ *| *$//g' \
          | tr -d '"' \
          | tr '\n' ' ')
        fi
        TAGS=$(echo "$TAGS" | xargs || true)
        echo "ã‚¿ã‚°: $TAGS"
        
        # ã‚«ãƒ†ã‚´ãƒªã‚’æŠ½å‡º
        CATEGORIES=$(printf "%s\n" "$FRONTMATTER" | awk '/^categories:/{flag=1;next}/^[[:alpha:]]/&&flag{flag=0}flag&&/- /{gsub(/^[[:space:]]*-[[:space:]]*/, ""); print}' | tr '\n' ' ')
        echo "ã‚«ãƒ†ã‚´ãƒª: $CATEGORIES"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰URLã‚’ç”Ÿæˆ
        FILENAME=$(basename "$POST_FILE" .md)
        URL_SLUG=$(echo "$FILENAME" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
        BLOG_URL="https://aoma23.com/${URL_SLUG}/"
        echo "URL: $BLOG_URL"

        # DATEãŒç©ºãªã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰è£œå®Œï¼ˆYYYY-MM-DDï¼‰
        if [ -z "$DATE" ]; then
          DATE_FROM_NAME=$(echo "$FILENAME" | awk -F'-' '{printf "%s-%s-%s",$1,$2,$3}')
          echo "date ãŒæœªè¨˜è¼‰ã®ãŸã‚ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰è£œå®Œ: $DATE_FROM_NAME"
          DATE="$DATE_FROM_NAME"
        fi
        
        # å‡ºåŠ›è¨­å®š
        echo "title=$TITLE" >> $GITHUB_OUTPUT
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "tags=$TAGS" >> $GITHUB_OUTPUT
        echo "categories=$CATEGORIES" >> $GITHUB_OUTPUT
        echo "url=$BLOG_URL" >> $GITHUB_OUTPUT
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT

    - name: Check post date
      id: date-check
      if: steps.metadata.outputs.title != ''
      run: |
        POST_DATE="${{ steps.metadata.outputs.date }}"
        CURRENT_DATE=$(date '+%Y-%m-%d')
        
        echo "è¨˜äº‹ã®æ—¥ä»˜: $POST_DATE"
        echo "ç¾åœ¨ã®æ—¥ä»˜: $CURRENT_DATE"
        
        # è¨˜äº‹ã®æ—¥ä»˜ãŒä»Šæ—¥ä»¥é™ã‹ãƒã‚§ãƒƒã‚¯
        if [[ "$POST_DATE" > "$CURRENT_DATE" ]]; then
          echo "â° æœªæ¥æ—¥ä»˜ã®è¨˜äº‹ã§ã™ã€‚ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å»¶æœŸã—ã¾ã™ã€‚"
          echo "should_tweet=false" >> $GITHUB_OUTPUT
          echo "reason=future_date" >> $GITHUB_OUTPUT
        else
          echo "âœ… å…¬é–‹å¯èƒ½ãªæ—¥ä»˜ã§ã™ã€‚ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
          echo "should_tweet=true" >> $GITHUB_OUTPUT
          echo "reason=ready_to_tweet" >> $GITHUB_OUTPUT
        fi

    - name: Generate tweet content
      id: tweet-content
      if: steps.date-check.outputs.should_tweet == 'true'
      run: |
        # ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ã‚’ç”Ÿæˆ
        TITLE="${{ steps.metadata.outputs.title }}"
        URL="${{ steps.metadata.outputs.url }}"
        TAGS="${{ steps.metadata.outputs.tags }}"
        CATEGORIES="${{ steps.metadata.outputs.categories }}"
        
        # ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ã®åŸºæœ¬è¦ç´ ã‚’å®šç¾©
        INTRO="æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸðŸ“"
        TITLE_PART="ã€Œ${TITLE}ã€"
        
        # ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’é…åˆ—ã«åŽé›†ï¼ˆå„ªå…ˆé †ä½ä»˜ãï¼‰
        PRIORITY_TAGS=""
        NORMAL_TAGS=""
        
        for tag in $TAGS $CATEGORIES; do
          # æ—¥æœ¬èªžã‚¿ã‚°ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆTwitterã§æ¤œç´¢ã•ã‚Œã«ãã„ãŸã‚ï¼‰
          if echo "$tag" | grep -q '[ã-ã‚Ÿ]'; then
            continue
          else
            tag_formatted="#$(echo "$tag" | sed 's/ //g')"
            # é‡è¦ãªã‚¿ã‚°ã‚’å„ªå…ˆ
            case "$tag" in
              "QuickBoard"|"TACTICALista"|"æˆ¦è¡“ãƒœãƒ¼ãƒ‰"|"ã‚µãƒƒã‚«ãƒ¼")
                PRIORITY_TAGS="$PRIORITY_TAGS $tag_formatted"
                ;;
              *)
                NORMAL_TAGS="$NORMAL_TAGS $tag_formatted"
                ;;
            esac
          fi
        done
        
        # åŸºæœ¬ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãªã—ï¼‰
        BASE_TWEET="${INTRO}"$'\n\n'"${TITLE_PART}"$'\n\n'
        BASE_LENGTH=$(echo -n "${BASE_TWEET}${URL}" | wc -c)
        
        echo "åŸºæœ¬æ–‡å­—æ•°ï¼ˆã‚¿ã‚¤ãƒˆãƒ«+URLï¼‰: $BASE_LENGTH"
        
        # ä½¿ç”¨å¯èƒ½ãªãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é ˜åŸŸã‚’è¨ˆç®—
        AVAILABLE_SPACE=$((280 - BASE_LENGTH - 1))  # æ”¹è¡Œåˆ†ã§-1
        
        # ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’æ®µéšŽçš„ã«è¿½åŠ 
        HASHTAGS=""
        
        # 1. å„ªå…ˆã‚¿ã‚°ã‚’è¿½åŠ 
        for tag in $PRIORITY_TAGS; do
          test_hashtags="$HASHTAGS $tag"
          if [ $(echo -n "$test_hashtags" | wc -c) -le $AVAILABLE_SPACE ]; then
            HASHTAGS="$test_hashtags"
          else
            break
          fi
        done
        
        # 2. é€šå¸¸ã‚¿ã‚°ã‚’è¿½åŠ ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãŒè¨±ã™é™ã‚Šï¼‰
        for tag in $NORMAL_TAGS; do
          test_hashtags="$HASHTAGS $tag"
          if [ $(echo -n "$test_hashtags" | wc -c) -le $AVAILABLE_SPACE ]; then
            HASHTAGS="$test_hashtags"
          else
            break
          fi
        done
        
        # æœ€çµ‚ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ã‚’æ§‹ç¯‰
        TWEET_TEXT="${BASE_TWEET}${HASHTAGS}"$'\n'"${URL}"
        
        # æœ€çµ‚æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
        FINAL_CHAR_COUNT=$(echo -n "$TWEET_TEXT" | wc -c)
        echo "æœ€çµ‚æ–‡å­—æ•°: $FINAL_CHAR_COUNT"
        echo "ä½¿ç”¨ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°:$HASHTAGS"
        
        echo "ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹:"
        echo "$TWEET_TEXT"
        
        # URL encode for safe transmission
        ENCODED_TWEET=$(echo "$TWEET_TEXT" | python3 -c "import sys,urllib.parse;print(urllib.parse.quote(sys.stdin.read()))")
        echo "content=$ENCODED_TWEET" >> $GITHUB_OUTPUT

    - name: Post to Twitter (OAuth 1.0a)
      if: steps.tweet-content.outputs.content != ''
      env:
        TWEET_CONTENT: ${{ steps.tweet-content.outputs.content }}
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
      run: |
        pip install --quiet requests requests-oauthlib
        python3 -c "import os,urllib.parse,requests;from requests_oauthlib import OAuth1;tc=urllib.parse.unquote(os.environ['TWEET_CONTENT']);auth=OAuth1(os.environ['TWITTER_API_KEY'],os.environ['TWITTER_API_SECRET'],os.environ['TWITTER_ACCESS_TOKEN'],os.environ['TWITTER_ACCESS_TOKEN_SECRET']);r=requests.post('https://api.twitter.com/2/tweets',json={'text':tc},auth=auth,timeout=15);print('Status:',r.status_code);print(r.text);r.raise_for_status()"

    - name: Create summary
      if: always()
      run: |
        echo "## ðŸ¦ è‡ªå‹•ãƒ„ã‚¤ãƒ¼ãƒˆçµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changed-files.outputs.files }}" != "" ]; then
          echo "### ðŸ“ å¯¾è±¡è¨˜äº‹" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.metadata.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.metadata.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.changed-files.outputs.files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¨˜äº‹ã®æ—¥ä»˜**: ${{ steps.metadata.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ—¥ä»˜ãƒã‚§ãƒƒã‚¯çµæžœã«åŸºã¥ã„ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
          if [ "${{ steps.date-check.outputs.reason }}" = "future_date" ]; then
            echo "### â° ãƒ„ã‚¤ãƒ¼ãƒˆå»¶æœŸ" >> $GITHUB_STEP_SUMMARY
            echo "æœªæ¥æ—¥ä»˜ã®è¨˜äº‹ã®ãŸã‚ã€ãƒ„ã‚¤ãƒ¼ãƒˆã‚’å»¶æœŸã—ã¾ã—ãŸã€‚Daily Site Rebuildã§å…¬é–‹æ™‚ã«è‡ªå‹•ãƒ„ã‚¤ãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.date-check.outputs.should_tweet }}" = "true" ] && [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… ãƒ„ã‚¤ãƒ¼ãƒˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "è¨˜äº‹ãŒæ­£å¸¸ã«Twitterã«æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.date-check.outputs.should_tweet }}" = "true" ]; then
            echo "### âŒ ãƒ„ã‚¤ãƒ¼ãƒˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "ãƒ„ã‚¤ãƒ¼ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ å‡¦ç†å®Œäº†" >> $GITHUB_STEP_SUMMARY
            echo "è¨˜äº‹ã‚’æ¤œå‡ºã—ã¾ã—ãŸãŒã€ãƒ„ã‚¤ãƒ¼ãƒˆæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### â„¹ï¸ æ–°ã—ã„è¨˜äº‹ãªã—" >> $GITHUB_STEP_SUMMARY
          echo "ä»Šå›žã®ã‚³ãƒŸãƒƒãƒˆã«ã¯æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
        fi
